#!/bin/zsh
set -e

# check if restic is installed and the settings are available
if ! command -v restic &> /dev/null; then
  echo "restic could not be found, please install it first"
  exit 1
fi

if [ ! -f ~/.zsh/restic_env.sh ]; then
  echo "restic environment file not found at ~/.zsh/restic_env.sh"
  exit 1
fi

source ~/.zsh/restic_env.sh
print $HOME

SOURCE_DIRS=(
  "$HOME/Documents"
  "$HOME/Desktop"
  "$HOME/Pictures"
)

RESTIC_OPTIONS=(-o s3.bucket-lookup=path -o s3.region=auto)

restic backup "${RESTIC_OPTIONS[@]}" "${SOURCE_DIRS[@]}" \
  --exclude-file <(cat <<'EOF'
# Big/ephemeral stuff to skip
$HOME/Library/Caches
$HOME/Library/Containers/com.apple.Safari/Data/Library/Caches
$HOME/Library/Mobile Documents/com~apple~CloudDocs/.Trash
$HOME/**/node_modules
$HOME/**/build
$HOME/**/.venv
$HOME/.Trash
**/.DS_Store
/Volumes/Time Machine Backups
EOF
)

restic forget "${RESTIC_OPTIONS[@]}" --prune --keep-daily 14 --keep-weekly 8 --keep-monthly 12 --keep-yearly 3

# Ping a URL to indicate the backup is done
if [ -z "$RESTIC_PING_URL" ]; then
  echo "RESTIC_PING_URL is not set, please set it in ~/.zsh/restic_env.sh"
  exit 1
fi

curl "$RESTIC_PING_URL"
