#!/usr/bin/env python
import os
import sys
import time


BLOCKED_DOMAINS = [
    "reddit.com",
    "www.reddit.com",
    "fr.reddit.com",
    "de.reddit.com",
    "news.ycombinator.com",
    "twitter.com",
    "mobile.twitter.com",
    "facebook.com",
    "www.facebook.com",
]

def block_domains():
    current_time = time.time()
    last_modified = os.path.getmtime('/etc/hosts')

    if current_time - last_modified > 60:
        # Don't update files when we don't need to.
        print('Skipping update since the file wasn''t updated')
        return

    lines = []
    domains = {domain: False for domain in BLOCKED_DOMAINS}

    with open('/etc/hosts', 'r') as fd:
        lines = fd.readlines()

    for line in lines:
        for domain in domains:
            if not line.startswith('#') and domain in line:
                domains[domain] = True

    absent_domains = {domain for domain in domains if domains[domain] is False}
    present_domains = {domain for domain in domains if domains[domain] is True}

    with open('/etc/hosts', 'w+') as fd:
        for line in lines:
            # If this isn't a comment, include it as is.
            if not line.startswith('#'):
                fd.write(line)
            else:
                # If this is a comment, does it contain one of the domains
                # we'd like to block? If yes, remove it.
                if any(domain in line for domain in domains):
                    continue
                else:
                    fd.write(line)

        for domain in absent_domains:
            fd.write("127.0.0.1 {}\n".format(domain))


if __name__ == '__main__':
    block_domains()
